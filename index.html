<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawDashboard2</title>
    <style>
        :root {
            --bg-body: #0b0f14;
            --bg-panel: #0f1520;
            --bg-header: #0c111a;
            --border-color: #1f2a37;
            --text-primary: #e5e7eb;
            --text-secondary: #9aa4b2;
            --accent: #60a5fa;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 6px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            display: grid;
            grid-template-rows: 56px 1fr;
        }

        header {
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .logo { font-weight: 700; letter-spacing: 0.5px; }
        .meta { font-size: 0.9rem; color: var(--text-secondary); }

        main {
            padding: 18px;
            display: grid;
            gap: 16px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 12px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label { color: var(--text-secondary); font-size: 0.85rem; margin-right: 6px; }
        select, button, input[type="checkbox"] {
            background: #0b1220;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .doc-btn {
            background: #0b1220;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.85rem;
        }

        button { cursor: pointer; }
        button:hover { border-color: #334155; }

        .dropdown { position: relative; }
        .dropdown-panel {
            position: absolute;
            top: 36px;
            left: 0;
            min-width: 240px;
            background: #0b1220;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            display: none;
            z-index: 10;
        }
        .dropdown-panel.open { display: block; }
        .dropdown-panel label { display: flex; align-items: center; gap: 8px; padding: 4px 0; }

        table { width: 100%; border-collapse: collapse; font-size: 0.92rem; }
        thead th {
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }
        tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(31, 42, 55, 0.6);
            vertical-align: top;
        }
        tbody tr:hover { background: rgba(96, 165, 250, 0.08); cursor: pointer; }
        .mono { font-family: var(--mono); }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .status-color { border-color: transparent; }
        .status-green { color: var(--success); }
        .status-blue { color: #60a5fa; }
        .status-yellow { color: var(--warning); }
        .status-orange { color: #fb923c; }
        .status-red { color: var(--danger); }

        .detail {
            display: grid;
            gap: 12px;
        }
        .detail h2 { font-size: 1.1rem; margin-bottom: 6px; }
        pre { white-space: pre-wrap; color: #cbd5e1; background: #0a0f16; padding: 10px; border-radius: 6px; border: 1px solid #111827; max-height: 300px; overflow: auto; }

        .muted { color: var(--text-secondary); }

        @media (max-width: 900px) {
            main { padding: 12px; }
            table { font-size: 0.85rem; }
            thead { display: none; }
            tbody tr { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 10px 0; }
            tbody td { border: none; }
            tbody td::before {
                content: attr(data-label);
                display: block;
                color: var(--text-secondary);
                font-size: 0.75rem;
                margin-bottom: 2px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">ðŸ“Ÿ ClawDashboard2 Console</div>
        <div class="meta" id="connection-status">Connecting...</div>
    </header>

    <main>
        <div class="panel">
            <div class="controls">
                <div>
                    <label>Sort by</label>
                    <select id="sort-key">
                        <option value="status">Status</option>
                        <option value="name">Agent Name</option>
                        <option value="todayLogCount">Today Logs</option>
                        <option value="lastUpdated">Last Updated</option>
                        <option value="defaultModel">Default Model</option>
                        <option value="taskOpen">Open Tasks</option>
                        <option value="taskTotal">Total Tasks</option>
                    </select>
                </div>

                <div>
                    <label>Direction</label>
                    <select id="sort-dir">
                        <option value="asc">Asc</option>
                        <option value="desc">Desc</option>
                    </select>
                </div>

                <div>
                    <label>Color</label>
                    <select id="color-mode">
                        <option value="off">Off (color-blind)</option>
                        <option value="on">On</option>
                    </select>
                </div>

                <div class="dropdown">
                    <button id="column-btn">Columns â–¾</button>
                    <div class="dropdown-panel" id="column-panel"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <table id="agent-table">
                <thead><tr id="table-head"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="panel detail" id="detail-panel">
            <div class="muted">Select an agent to view details.</div>
        </div>
    </main>

    <script>
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const DEFAULT_SETTINGS = {
            sortKey: 'status',
            sortDir: 'asc',
            colorMode: 'off',
            columns: {
                name: true,
                status: true,
                todayLogCount: true,
                lastUpdated: true,
                defaultModel: true,
                tasks: true,
            }
        };

        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem('clawDashboardSettings'));
                return { ...DEFAULT_SETTINGS, ...saved, columns: { ...DEFAULT_SETTINGS.columns, ...(saved?.columns || {}) } };
            } catch {
                return DEFAULT_SETTINGS;
            }
        }

        function saveSettings() {
            localStorage.setItem('clawDashboardSettings', JSON.stringify(settings));
        }

        let settings = loadSettings();
        let agents = new Map();
        let selectedAgentId = null;
        let selectedDoc = null;

        const statusEl = document.getElementById('connection-status');
        const sortKeyEl = document.getElementById('sort-key');
        const sortDirEl = document.getElementById('sort-dir');
        const colorModeEl = document.getElementById('color-mode');
        const columnBtn = document.getElementById('column-btn');
        const columnPanel = document.getElementById('column-panel');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const detailPanel = document.getElementById('detail-panel');

        sortKeyEl.value = settings.sortKey;
        sortDirEl.value = settings.sortDir;
        colorModeEl.value = settings.colorMode;

        sortKeyEl.onchange = () => { settings.sortKey = sortKeyEl.value; saveSettings(); renderTable(); };
        sortDirEl.onchange = () => { settings.sortDir = sortDirEl.value; saveSettings(); renderTable(); };
        colorModeEl.onchange = () => { settings.colorMode = colorModeEl.value; saveSettings(); renderTable(); };

        columnBtn.onclick = () => columnPanel.classList.toggle('open');
        document.addEventListener('click', (e) => {
            if (!columnPanel.contains(e.target) && e.target !== columnBtn) {
                columnPanel.classList.remove('open');
            }
        });

        const COLUMN_DEFS = [
            { key: 'name', label: 'Agent Name' },
            { key: 'status', label: 'Status' },
            { key: 'todayLogCount', label: 'Today Logs' },
            { key: 'lastUpdated', label: 'Last Updated' },
            { key: 'defaultModel', label: 'Default Model' },
            { key: 'tasks', label: 'Tasks (total/open)' },
        ];

        function renderColumnPanel() {
            columnPanel.innerHTML = COLUMN_DEFS.map(col => {
                const checked = settings.columns[col.key] ? 'checked' : '';
                return `
                    <label>
                        <input type="checkbox" data-col="${col.key}" ${checked} />
                        ${col.label}
                    </label>
                `;
            }).join('');

            columnPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.onchange = (e) => {
                    const key = e.target.getAttribute('data-col');
                    settings.columns[key] = e.target.checked;
                    saveSettings();
                    renderTable();
                };
            });
        }

        function statusRank(agent) {
            const r = agent?.status?.r || 'ðŸŸ¢';
            const order = { 'ðŸ”´': 0, 'ðŸŸ ': 1, 'ðŸŸ¡': 2, 'ðŸ”µ': 3, 'ðŸŸ¢': 4 };
            return (r in order) ? order[r] : 5;
        }

        function getSortValue(agent, key) {
            const tasks = agent.tasks || [];
            const open = tasks.filter(t => t.status !== 'done' && t.status !== 'cancelled').length;
            const total = tasks.length;

            switch (key) {
                case 'status': return statusRank(agent);
                case 'name': return (agent.name || '').toLowerCase();
                case 'todayLogCount': return agent.todayLogCount || 0;
                case 'lastUpdated': return agent.lastUpdated || 0;
                case 'defaultModel': return (agent.defaultModel || '').toLowerCase();
                case 'taskOpen': return open;
                case 'taskTotal': return total;
                default: return 0;
            }
        }

        function sortAgents(list) {
            const dir = settings.sortDir === 'asc' ? 1 : -1;
            return list.sort((a, b) => {
                const va = getSortValue(a, settings.sortKey);
                const vb = getSortValue(b, settings.sortKey);
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return (b.lastUpdated || 0) - (a.lastUpdated || 0);
            });
        }

        function formatTime(ts) {
            if (!ts) return '-';
            try {
                return new Date(ts).toLocaleString();
            } catch {
                return '-';
            }
        }

        function getStatusClass(r) {
            if (r === 'ðŸ”´') return 'status-red';
            if (r === 'ðŸŸ ') return 'status-orange';
            if (r === 'ðŸŸ¡') return 'status-yellow';
            if (r === 'ðŸ”µ') return 'status-blue';
            return 'status-green';
        }

        function renderTable() {
            renderColumnPanel();
            const cols = COLUMN_DEFS.filter(c => settings.columns[c.key]);

            tableHead.innerHTML = cols.map(c => `<th>${c.label}</th>`).join('');
            const sorted = sortAgents(Array.from(agents.values()));

            tableBody.innerHTML = sorted.map(agent => {
                const tasks = agent.tasks || [];
                const open = tasks.filter(t => t.status !== 'done' && t.status !== 'cancelled').length;
                const total = tasks.length;
                const statusIcon = agent.status?.r || 'ðŸŸ¢';
                const statusText = agent.status?.text || 'idle';
                const statusClass = settings.colorMode === 'on' ? `status-color ${getStatusClass(statusIcon)}` : '';

                const rowCells = cols.map(col => {
                    switch (col.key) {
                        case 'name':
                            return `<td data-label="${col.label}">${escapeHtml(agent.name || '-')}</td>`;
                        case 'status':
                            return `<td data-label="${col.label}"><span class="status-badge ${statusClass}">${statusIcon} ${escapeHtml(statusText)}</span></td>`;
                        case 'todayLogCount':
                            return `<td data-label="${col.label}" class="mono">${agent.todayLogCount ?? 0}</td>`;
                        case 'lastUpdated':
                            return `<td data-label="${col.label}" class="mono">${formatTime(agent.lastUpdated)}</td>`;
                        case 'defaultModel':
                            return `<td data-label="${col.label}" class="mono">${escapeHtml(agent.defaultModel || '-') }</td>`;
                        case 'tasks':
                            return `<td data-label="${col.label}" class="mono">${total}/${open}</td>`;
                        default:
                            return `<td data-label="${col.label}">-</td>`;
                    }
                }).join('');

                return `<tr data-id="${agent.id}">${rowCells}</tr>`;
            }).join('');

            tableBody.querySelectorAll('tr').forEach(row => {
                row.onclick = () => selectAgent(row.getAttribute('data-id'));
            });
        }

        function selectAgent(id) {
            selectedAgentId = id;
            selectedDoc = null;
            renderDetail();
        }

        async function loadDoc(agentId, filename) {
            try {
                const res = await fetch(`/api/file?id=${encodeURIComponent(agentId)}&file=${encodeURIComponent(filename)}`);
                if (res.ok) {
                    return await res.text();
                }
                return `Error loading file: ${res.statusText}`;
            } catch (e) {
                return `Error: ${e.message}`;
            }
        }

        async function saveDoc(agentId, filename, content) {
            const res = await fetch(`/api/file?id=${encodeURIComponent(agentId)}&file=${encodeURIComponent(filename)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                body: content
            });
            if (!res.ok) throw new Error(await res.text());
            return true;
        }

        function renderDetail() {
            const agent = agents.get(selectedAgentId);
            if (!agent) {
                detailPanel.innerHTML = '<div class="muted">Select an agent to view details.</div>';
                return;
            }

            const statusIcon = agent.status?.r || 'ðŸŸ¢';
            const statusText = agent.status?.text || 'idle';
            const tasks = agent.tasks || [];

            const tasksHtml = tasks.map(task => {
                let icon = '[ ]';
                if (task.status === 'done') { icon = '[x]'; }
                if (task.status === 'in-progress') { icon = '[/]'; }
                if (task.status === 'blocked') { icon = '[!]'; }
                if (task.status === 'cancelled') { icon = '[~]'; }
                return `<li class="mono">${icon} ${escapeHtml(task.text)}</li>`;
            }).join('');

            const logs = agent.log || [];
            const logsHtml = logs.map(l => `<li class="mono">${escapeHtml(l)}</li>`).join('');

            const docs = (agent.docs || []).sort();
            const docsButtons = docs.map(doc => {
                const active = selectedDoc === doc ? 'style="border-color:#60a5fa"' : '';
                return `<button class="doc-btn" ${active} onclick="viewDoc('${agent.id}', '${doc}')">ðŸ“„ ${doc}</button>`;
            }).join('');

            detailPanel.innerHTML = `
                <div>
                    <h2>${escapeHtml(agent.name || '-')}
                        <span class="status-badge">${statusIcon} ${escapeHtml(statusText)}</span>
                    </h2>
                    <div class="muted mono">ID: ${escapeHtml(agent.id)}</div>
                    <div style="margin-top:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <label class="muted">Agent Name</label>
                        <input id="agent-name-input" value="${escapeHtml(agent.name || '')}" style="background:#0b1220;border:1px solid var(--border-color);color:#fff;border-radius:6px;padding:4px 8px;" />
                        <button onclick="saveAgentName('${agent.id}')">Save</button>
                        <span class="muted" style="font-size:0.8em;">(writes to IDENTITY.md)</span>
                    </div>
                </div>
                <div>
                    <strong>Tasks</strong>
                    ${tasks.length ? `<ul>${tasksHtml}</ul>` : '<div class="muted">No tasks</div>'}
                </div>
                <div>
                    <strong>Log</strong>
                    ${logs.length ? `<ul>${logsHtml}</ul>` : '<div class="muted">No logs</div>'}
                </div>
                <div>
                    <strong>MEMORY.md</strong>
                    ${agent.memory ? `<pre>${escapeHtml(agent.memory)}</pre>` : '<div class="muted">No memory found.</div>'}
                </div>
                <div>
                    <strong>All Markdown (including daily notes)</strong>
                    ${docs.length ? `
                        <div style="display:flex; flex-wrap:wrap; gap:6px; margin:6px 0;">
                            ${docsButtons}
                        </div>
                        <div id="doc-viewer" style="margin-top:8px;">
                            <div class="muted">Select a document to preview.</div>
                        </div>
                    ` : '<div class="muted">No extra markdown files.</div>'}
                </div>
            `;
        }

        window.viewDoc = async function(agentId, filename) {
            selectedDoc = filename;
            const content = await loadDoc(agentId, filename);
            const viewer = document.getElementById('doc-viewer');
            if (viewer) {
                viewer.innerHTML = `
                    <div class="muted" style="margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; gap:8px;">
                        <span>${filename}</span>
                        <button onclick="saveDocContent('${agentId}', '${filename}')">Save</button>
                    </div>
                    <textarea id="doc-editor" style="width:100%; min-height:260px; background:#0b1220; color:#e5e7eb; border:1px solid var(--border-color); border-radius:6px; padding:8px; font-family:var(--mono);">${escapeHtml(content)}</textarea>
                `;
            }
        };

        window.saveDocContent = async function(agentId, filename) {
            const editor = document.getElementById('doc-editor');
            if (!editor) return;
            try {
                await saveDoc(agentId, filename, editor.value);
                await refreshAgents();
                alert('Saved');
            } catch (e) {
                alert('Save failed: ' + e.message);
            }
        };

        window.saveAgentName = async function(agentId) {
            const input = document.getElementById('agent-name-input');
            if (!input) return;
            const name = input.value.trim();
            const identity = `# Identity\n\n- **Name**: ${name}\n`;
            try {
                await saveDoc(agentId, 'IDENTITY.md', identity);
                await refreshAgents();
                alert('Saved');
            } catch (e) {
                alert('Save failed: ' + e.message);
            }
        };

        async function refreshAgents() {
            try {
                const res = await fetch('/api/agents');
                if (res.ok) {
                    const list = await res.json();
                    agents.clear();
                    list.forEach(a => agents.set(a.id, a));
                    renderTable();
                    renderDetail();
                }
            } catch {}
        }

        function connectSSE() {
            const es = new EventSource('/api/events');

            es.onopen = () => {
                statusEl.textContent = 'ðŸŸ¢ Connected';
                statusEl.style.color = 'var(--success)';
            };

            es.onerror = () => {
                statusEl.textContent = 'ðŸ”´ Disconnected';
                statusEl.style.color = 'var(--danger)';
            };

            es.addEventListener('init', e => {
                const list = JSON.parse(e.data);
                agents.clear();
                list.forEach(a => agents.set(a.id, a));
                renderTable();
                renderDetail();
            });

            es.addEventListener('update', e => {
                const agent = JSON.parse(e.data);
                agents.set(agent.id, agent);
                renderTable();
                if (selectedAgentId === agent.id) renderDetail();
            });

            es.addEventListener('remove', e => {
                const { id } = JSON.parse(e.data);
                agents.delete(id);
                if (selectedAgentId === id) selectedAgentId = null;
                renderTable();
                renderDetail();
            });
        }

        renderColumnPanel();
        renderTable();
        connectSSE();
    </script>
</body>

</html>
